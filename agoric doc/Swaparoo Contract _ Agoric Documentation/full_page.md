
 [Skip to content](#VPContent) [![](/agoric-logo-red.svg)Agoric Documentation](/)Search`K` Main Navigation Orchestrate[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)

Contract Walkthroughs

[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)

Example Orchestration DApp

[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)Build[Getting Started](/guides/getting-started/)[Smart Contract Basics](/guides/zoe/contract-basics.html)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[Permissioned Contract Deployment](/guides/coreeval/)[Integrating with Agoric Network](/guides/integration/chain-integration.html)[Agoric CLI](/guides/agoric-cli/)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[ERTP API](/reference/ertp-api/)[Zoe API](/reference/zoe-api/)[Example Zoe Contracts](/guides/zoe/contracts/)[End-to-End Testing](/e2e-testing.html)Learn[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[ERTP](/guides/ertp/)[JavaScript Framework](/guides/js-programming/)[Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)Tutorials[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[UI Tutorial](/guides/getting-started/ui-tutorial/)Support[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Github Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)

Appearance

MenuReturn to top Sidebar Navigation 

Orchestrate
-----------

[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)[### Contract Walkthroughs](/guides/orchestration/contract-walkthroughs/)[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)[### Example Orchestration DApp](/guides/orchestration/orchestration-basics/)[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)

Build
-----

[### Getting Started](/guides/getting-started/)[Takeaway 1: Starting a Local Chain](/guides/getting-started/explainer-how-to-start-a-local-chain.html)[Takeaway 2: Deploying a Smart Contract](/guides/getting-started/explainer-deploying-a-smart-contact.html)[Takeaway 3: Making an Offer](/guides/getting-started/explainer-how-to-make-an-offer.html)[### Smart Contract Basics](/guides/zoe/contract-basics.html)[Hello World Smart Contract](/guides/zoe/contract-hello.html)[State Smart Contract](/guides/zoe/contract-state.html)[Access Control Smart Contract](/guides/zoe/contract-access-control.html)[Complete Contract Walk-Through](/guides/zoe/contract-walkthru.html)[Durable Contract Details](/guides/zoe/contract-details.html)[Contract Upgrade](/guides/zoe/contract-upgrade.html)[Contract Governance](/guides/governance/)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[### Permissioned Contract Deployment](/guides/coreeval/)[Write Code to Deploy a Contract](/guides/coreeval/proposal.html)[Declare Required Capabilities](/guides/coreeval/permissions.html)[Submit Transactions](/guides/coreeval/local-testnet.html)[### Integrating with Agoric Network](/guides/integration/chain-integration.html)[Name Services: agoricNames, namesByAddress, board](/guides/integration/name-services.html)[SubQuery Indexing](/guides/subquery-indexing.html)[### Agoric CLI](/guides/agoric-cli/)[Agoric CLI Reference](/guides/agoric-cli/)[Using agd to make queries and transactions](/guides/agoric-cli/agd-query-tx.html)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[### ERTP API](/reference/ertp-api/)[ERTP API](/reference/ertp-api/)[Issuer Object](/reference/ertp-api/issuer.html)[Mint Object](/reference/ertp-api/mint.html)[Brand Object](/reference/ertp-api/brand.html)[Purse Object](/reference/ertp-api/purse.html)[Payment Object](/reference/ertp-api/payment.html)[AmountMath Object](/reference/ertp-api/amount-math.html)[ERTP Data Types](/reference/ertp-api/ertp-data-types.html)[### Zoe API](/reference/zoe-api/)[Zoe API](/reference/zoe-api/)[Zoe Service](/reference/zoe-api/zoe.html)[UserSeat Object](/reference/zoe-api/user-seat.html)[Zoe Contract Facet (ZCF)](/reference/zoe-api/zoe-contract-facet.html)[ZCFSeat Object](/reference/zoe-api/zcfseat.html)[ZCFMint Object](/reference/zoe-api/zcfmint.html)[ZoeHelper Functions](/reference/zoe-api/zoe-helpers.html)[Ratio Math Functions](/reference/zoe-api/ratio-math.html)[Zoe Data Types](/reference/zoe-api/zoe-data-types.html)[### Example Zoe Contracts](/guides/zoe/contracts/)[Example Zoe Contracts](/guides/zoe/contracts/)[Oracle Query Contract](/guides/zoe/contracts/oracle.html)[Vault Contract](/guides/zoe/contracts/vault.html)[Loan Contract](/guides/zoe/contracts/loan.html)[Funded Call Spread Contract](/guides/zoe/contracts/fundedCallSpread.html)[Priced Call Spread Contract](/guides/zoe/contracts/pricedCallSpread.html)[Covered Call Contract](/guides/zoe/contracts/covered-call.html)[OTC Desk Contract](/guides/zoe/contracts/otc-desk.html)[ConstantProduct AMM Contract](/guides/zoe/contracts/constantProductAMM.html)[Sell Items Contract](/guides/zoe/contracts/sell-items.html)[Atomic Swap Contract](/guides/zoe/contracts/atomic-swap.html)[Barter Exchange Contract](/guides/zoe/contracts/barter-exchange.html)[Second-Price Auction Contract](/guides/zoe/contracts/second-price-auction.html)[Simple Exchange Contract](/guides/zoe/contracts/simple-exchange.html)[Escrow To Vote Contract](/guides/zoe/contracts/escrow-to-vote.html)[Mint Payments Contract](/guides/zoe/contracts/mint-payments.html)[Mint and Sell NFTs Contract](/guides/zoe/contracts/mint-and-sell-nfts.html)[Use Object Contract](/guides/zoe/contracts/use-obj-example.html)[Automatic Refund Contract](/guides/zoe/contracts/automatic-refund.html)[End-to-End Testing](/e2e-testing.html)

Learn
-----

[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[### ERTP](/guides/ertp/)[Amounts, Values, and Brands](/guides/ertp/amounts.html)[AmountMath](/guides/ertp/amount-math.html)[Issuers and Mints](/guides/ertp/issuers-and-mints.html)[Purses and Payments](/guides/ertp/purses-and-payments.html)[JavaScript Framework](/guides/js-programming/)[### Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[PSM Contract](/guides/zoe/actual-contracts/PSM.html)[PriceAuthority Object](/reference/zoe-api/price-authority.html)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)

Tutorials
---------

[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[### dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[Takeaway 1: Sell Concert Tickets Contract Overview](/guides/getting-started/sell-concert-tickets-contract-explainer.html)[Takeaway 2: Swaparoo Contract Overview](/guides/getting-started/swaparoo-how-to-swap-assets-explainer.html)[Takeaway 3: Sending Invitation Payments using an Address](/guides/getting-started/swaparoo-making-a-payment-explainer.html)[### UI Tutorial](/guides/getting-started/ui-tutorial/)[1. Starting](/guides/getting-started/ui-tutorial/starting.html)[2. Agoric Provider](/guides/getting-started/ui-tutorial/agoric-provider.html)[3. Connect Wallet](/guides/getting-started/ui-tutorial/connect-wallet.html)[4. Querying Vstorage](/guides/getting-started/ui-tutorial/querying-vstorage.html)[5. Making an Offer](/guides/getting-started/ui-tutorial/making-an-offer.html)[6. Conclusion](/guides/getting-started/ui-tutorial/conclusion.html)

Support
-------

[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)On this page

Swaparoo Contract [​](#swaparoo-contract)
=========================================

This smart contract is designed to allow two parties to swap assets between themselves, with a fee charged to one of the parties. The contract is started with a `feeAmount` and a `namesByAddressAdmin` object, which is used to retrieve a deposit facet for the second party.

**NOTE:** *`namesByAddressAdmin` is actually excess authority in this scenario. Normally read-only access can be attained via `namesByAddress`. The use of `namesByAddressAdmin` in this example is due to a bug, which will be addressed in an upcoming release.*

Let's take a look at how this contract works:

Setting up Fee Handling [​](#setting-up-fee-handling)
-----------------------------------------------------

The contract retrieves the `feeIssuer` from the Zoe service, which is an issuer for the stable token used for fees. It creates a `feeSeat` and a `feeShape` based on the `feeAmount` specified in the contract terms.

js
```
const stableIssuer = await E(zcf.getZoeService()).getFeeIssuer();
const feeBrand = await E(stableIssuer).getBrand();
const { zcfSeat: feeSeat } = zcf.makeEmptySeatKit();
const feeShape = makeNatAmountShape(feeBrand, feeAmount.value);
```

Making the First Invitation [​](#making-the-first-invitation)
-------------------------------------------------------------

The `makeFirstInvitation` function is called with an array of issuers. It verifies that these issuers are part of the contract terms and saves any new issuers to the contract. It then creates an invitation with a proposal shape that includes the `feeShape` in the give record.

js
```
const makeFirstInvitation = issuers => {
  mustMatch(issuers, M.arrayOf(IssuerShape));
  for (const i of issuers) {
    if (!Object.values(zcf.getTerms().issuers).includes(i)) {
      zcf.saveIssuer(i, `Issuer${(issuerNumber += 1)}`);
    }
  }
  const proposalShape = M.splitRecord({
    give: M.splitRecord({ Fee: feeShape })
  });

  const firstInvitation = zcf.makeInvitation(
    makeSecondInvitation,
    'create a swap',
    undefined,
    proposalShape
  );
  return firstInvitation;
};
```

Making the Second Invitation [​](#making-the-second-invitation)
---------------------------------------------------------------

When the first party accepts the invitation, the `makeSecondInvitation` function is called. This function retrieves the deposit facet for the second party using the `namesByAddressAdmin` object and the provided address.

js
```
const makeSecondInvitation = async (firstSeat, offerArgs) => {
  mustMatch(offerArgs, harden({ addr: M.string() }));
  const { addr: secondPartyAddress } = offerArgs;

  const secondDepositFacet = await E(depositFacetFromAddr).lookup(
    secondPartyAddress,
    'depositFacet'
  );
  // ...
};
```

From there a second invitation is created with an offer handler that checks if the second party's proposal matches the first party's want. If it does, it calls the `swapWithFee` function to perform the asset swap and collect the fee.

js
```
const secondSeatOfferHandler = secondSeat => {
  if (!matches(secondSeat.getProposal(), makeSecondProposalShape(want1))) {
    // Handle mismatched proposals
    return;
  }

  return swapWithFee(zcf, firstSeat, secondSeat, feeSeat, feeAmount);
};

const secondSeatInvitation = await zcf.makeInvitation(
  secondSeatOfferHandler,
  'matchOffer',
  { give: give1, want: want1 }
);
```

Performing the swap [​](#performing-the-swap)
---------------------------------------------

The `swapWithFee` function uses the `atomicRearrange` function from Zoe to perform the asset swap and collect the fee. It rearranges the assets between the first seat, second seat, and the feeSeat.

js
```
export const swapWithFee = (zcf, firstSeat, secondSeat, feeSeat, feeAmount) => {
  const { Fee: _, ...firstGive } = firstSeat.getProposal().give;

  atomicRearrange(
    zcf,
    harden([
      [firstSeat, secondSeat, firstGive],
      [secondSeat, firstSeat, secondSeat.getProposal().give],
      [firstSeat, feeSeat, { Fee: feeAmount }]
    ])
  );

  firstSeat.exit();
  secondSeat.exit();
  return 'success';
};
```

Collecting fees [​](#collecting-fees)
-------------------------------------

The contract also provides a `creatorFacet` with a `makeCollectFeesInvitation` method, which creates an invitation to collect the fees accumulated in the feeSeat.

js
```
const creatorFacet = Far('Creator', {
  makeCollectFeesInvitation() {
    return makeCollectFeesInvitation(zcf, feeSeat, feeBrand, 'Fee');
  }
});
```

Video Walkthrough [​](#video-walkthrough)
-----------------------------------------

Watch this short video walk-through of the complete Swaparoo Smart Contract that allows any two parties to trade any digital assets with minimal risk.

 [Help us improve this page!](https://github.com/Agoric/documentation/edit/main/main/guides/getting-started/swaparoo-how-to-swap-assets-explainer.md)

Last Updated: 

Pager[Previous pageTakeaway 1: Sell Concert Tickets Contract Overview](/guides/getting-started/sell-concert-tickets-contract-explainer.html)[Next pageTakeaway 3: Sending Invitation Payments using an Address](/guides/getting-started/swaparoo-making-a-payment-explainer.html)

© 2024 Agoric Systems Operating Company. All Rights Reserved.



