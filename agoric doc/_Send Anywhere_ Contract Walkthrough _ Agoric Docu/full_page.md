
 [Skip to content](#VPContent) [![](/agoric-logo-red.svg)Agoric Documentation](/)Search`K` Main Navigation Orchestrate[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)

Contract Walkthroughs

[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)

Example Orchestration DApp

[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)Build[Getting Started](/guides/getting-started/)[Smart Contract Basics](/guides/zoe/contract-basics.html)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[Permissioned Contract Deployment](/guides/coreeval/)[Integrating with Agoric Network](/guides/integration/chain-integration.html)[Agoric CLI](/guides/agoric-cli/)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[ERTP API](/reference/ertp-api/)[Zoe API](/reference/zoe-api/)[Example Zoe Contracts](/guides/zoe/contracts/)[End-to-End Testing](/e2e-testing.html)Learn[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[ERTP](/guides/ertp/)[JavaScript Framework](/guides/js-programming/)[Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)Tutorials[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[UI Tutorial](/guides/getting-started/ui-tutorial/)Support[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Github Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)

Appearance

MenuReturn to top Sidebar Navigation 

Orchestrate
-----------

[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)[### Contract Walkthroughs](/guides/orchestration/contract-walkthroughs/)[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)[### Example Orchestration DApp](/guides/orchestration/orchestration-basics/)[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)

Build
-----

[### Getting Started](/guides/getting-started/)[Takeaway 1: Starting a Local Chain](/guides/getting-started/explainer-how-to-start-a-local-chain.html)[Takeaway 2: Deploying a Smart Contract](/guides/getting-started/explainer-deploying-a-smart-contact.html)[Takeaway 3: Making an Offer](/guides/getting-started/explainer-how-to-make-an-offer.html)[### Smart Contract Basics](/guides/zoe/contract-basics.html)[Hello World Smart Contract](/guides/zoe/contract-hello.html)[State Smart Contract](/guides/zoe/contract-state.html)[Access Control Smart Contract](/guides/zoe/contract-access-control.html)[Complete Contract Walk-Through](/guides/zoe/contract-walkthru.html)[Durable Contract Details](/guides/zoe/contract-details.html)[Contract Upgrade](/guides/zoe/contract-upgrade.html)[Contract Governance](/guides/governance/)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[### Permissioned Contract Deployment](/guides/coreeval/)[Write Code to Deploy a Contract](/guides/coreeval/proposal.html)[Declare Required Capabilities](/guides/coreeval/permissions.html)[Submit Transactions](/guides/coreeval/local-testnet.html)[### Integrating with Agoric Network](/guides/integration/chain-integration.html)[Name Services: agoricNames, namesByAddress, board](/guides/integration/name-services.html)[SubQuery Indexing](/guides/subquery-indexing.html)[### Agoric CLI](/guides/agoric-cli/)[Agoric CLI Reference](/guides/agoric-cli/)[Using agd to make queries and transactions](/guides/agoric-cli/agd-query-tx.html)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[### ERTP API](/reference/ertp-api/)[ERTP API](/reference/ertp-api/)[Issuer Object](/reference/ertp-api/issuer.html)[Mint Object](/reference/ertp-api/mint.html)[Brand Object](/reference/ertp-api/brand.html)[Purse Object](/reference/ertp-api/purse.html)[Payment Object](/reference/ertp-api/payment.html)[AmountMath Object](/reference/ertp-api/amount-math.html)[ERTP Data Types](/reference/ertp-api/ertp-data-types.html)[### Zoe API](/reference/zoe-api/)[Zoe API](/reference/zoe-api/)[Zoe Service](/reference/zoe-api/zoe.html)[UserSeat Object](/reference/zoe-api/user-seat.html)[Zoe Contract Facet (ZCF)](/reference/zoe-api/zoe-contract-facet.html)[ZCFSeat Object](/reference/zoe-api/zcfseat.html)[ZCFMint Object](/reference/zoe-api/zcfmint.html)[ZoeHelper Functions](/reference/zoe-api/zoe-helpers.html)[Ratio Math Functions](/reference/zoe-api/ratio-math.html)[Zoe Data Types](/reference/zoe-api/zoe-data-types.html)[### Example Zoe Contracts](/guides/zoe/contracts/)[Example Zoe Contracts](/guides/zoe/contracts/)[Oracle Query Contract](/guides/zoe/contracts/oracle.html)[Vault Contract](/guides/zoe/contracts/vault.html)[Loan Contract](/guides/zoe/contracts/loan.html)[Funded Call Spread Contract](/guides/zoe/contracts/fundedCallSpread.html)[Priced Call Spread Contract](/guides/zoe/contracts/pricedCallSpread.html)[Covered Call Contract](/guides/zoe/contracts/covered-call.html)[OTC Desk Contract](/guides/zoe/contracts/otc-desk.html)[ConstantProduct AMM Contract](/guides/zoe/contracts/constantProductAMM.html)[Sell Items Contract](/guides/zoe/contracts/sell-items.html)[Atomic Swap Contract](/guides/zoe/contracts/atomic-swap.html)[Barter Exchange Contract](/guides/zoe/contracts/barter-exchange.html)[Second-Price Auction Contract](/guides/zoe/contracts/second-price-auction.html)[Simple Exchange Contract](/guides/zoe/contracts/simple-exchange.html)[Escrow To Vote Contract](/guides/zoe/contracts/escrow-to-vote.html)[Mint Payments Contract](/guides/zoe/contracts/mint-payments.html)[Mint and Sell NFTs Contract](/guides/zoe/contracts/mint-and-sell-nfts.html)[Use Object Contract](/guides/zoe/contracts/use-obj-example.html)[Automatic Refund Contract](/guides/zoe/contracts/automatic-refund.html)[End-to-End Testing](/e2e-testing.html)

Learn
-----

[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[### ERTP](/guides/ertp/)[Amounts, Values, and Brands](/guides/ertp/amounts.html)[AmountMath](/guides/ertp/amount-math.html)[Issuers and Mints](/guides/ertp/issuers-and-mints.html)[Purses and Payments](/guides/ertp/purses-and-payments.html)[JavaScript Framework](/guides/js-programming/)[### Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[PSM Contract](/guides/zoe/actual-contracts/PSM.html)[PriceAuthority Object](/reference/zoe-api/price-authority.html)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)

Tutorials
---------

[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[### dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[Takeaway 1: Sell Concert Tickets Contract Overview](/guides/getting-started/sell-concert-tickets-contract-explainer.html)[Takeaway 2: Swaparoo Contract Overview](/guides/getting-started/swaparoo-how-to-swap-assets-explainer.html)[Takeaway 3: Sending Invitation Payments using an Address](/guides/getting-started/swaparoo-making-a-payment-explainer.html)[### UI Tutorial](/guides/getting-started/ui-tutorial/)[1. Starting](/guides/getting-started/ui-tutorial/starting.html)[2. Agoric Provider](/guides/getting-started/ui-tutorial/agoric-provider.html)[3. Connect Wallet](/guides/getting-started/ui-tutorial/connect-wallet.html)[4. Querying Vstorage](/guides/getting-started/ui-tutorial/querying-vstorage.html)[5. Making an Offer](/guides/getting-started/ui-tutorial/making-an-offer.html)[6. Conclusion](/guides/getting-started/ui-tutorial/conclusion.html)

Support
-------

[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)On this page

"Send Anywhere" Contract Walkthrough [​](#send-anywhere-contract-walkthrough)
=============================================================================

The "Send Anywhere" contract is designed to facilitate the transfer of assets from one chain to another using Agoric's [Orchestration](/glossary/#orchestration) library. The contract allows a user to send assets of a specific brand to a destination address on any supported blockchain.

The high-level flow of the contract is:

* Validates the asset brand on the source chain.
* Creates or ensures the existence of a local account (held by the contract) to handle temporary holding.
* Transfers the asset from the source address to the local account.
* Initiates a transfer to the destination address, which could reside on the remote blockchain.
* Gracefully handles the failures.

The contract is implemented in two separate files:

1. `send-anywhere.contract.js` implements the `start` function of the contract to initialize the contract and expose `publicFacet`.
2. `send-anywhere.flows.js` implements the `sendIt` function which performs the actual transfer of assets when a user makes an offer.

Let us walk through these files one by one.

1. `send-anywhere.contract.js` [​](#_1-send-anywhere-contract-js)
-----------------------------------------------------------------

The contract begins by importing various modules and utilities necessary for its functionality. These include:

* **State management**: `makeSharedStateRecord` is imported to create and manage the state across contract incarnations.
* **Type validation**: `AmountShape` and `InvitationShape` ensure that the contract works with correct data types, such as amounts and invitations.
* **Orchestration utilities**: `withOrchestration` is imported to facilitate interactions with Orchestration functions.
* **Flows**: The Orchestration flows for handling transfers are imported from `send-anywhere.flows.js` to be made available to Zoe.

These imports set up the contract for the validation, orchestration, and execution of transfers through Zoe API.

### Single Amount Record Validation [​](#single-amount-record-validation)

In order to ensure that only a single asset (or `brand`) is transferred per transaction, a `SingleNatAmountRecord` is defined:

js
```
export const SingleNatAmountRecord = M.and(
  M.recordOf(M.string(), AnyNatAmountShape, {
    numPropertiesLimit: 1
  }),
  M.not(harden({}))
);
harden(SingleNatAmountRecord);
```

This validation ensures that the proposal shape submitted by users contains exactly one asset and no other extraneous properties.

### Contract State Setup [​](#contract-state-setup)

The contract defines a shared state record as below:

js
```
const contractState = makeSharedStateRecord(
  /** @type {{ account: OrchestrationAccount<any> | undefined }} */ {
    localAccount: undefined
  }
);
```

This state keeps track of the local account that will hold the transferred assets temporarily before they are sent to the destination address. The state starts with an undefined `localAccount`. This account will be created later during the offer handling process if needed.

### Logging setup [​](#logging-setup)

The contract initializes a logging mechanism (`logNode`) to capture the contract's internal actions and state changes. Logs are written to a newly created `log` child in VStorage, making debugging and auditing easier.

js
```
const logNode = E(privateArgs.storageNode).makeChildNode('log');

const log = msg => vowTools.watch(E(logNode).setValue(msg));
```
### Orchestration functions [​](#orchestration-functions)

These functions, imported from `send-anywhere.flows.js`, define the main behaviors for handling asset transfers. The contract wraps these functions with the necessary context (such as the contract state, logging, and Zoe tools).

js
```
const orchFns = orchestrateAll(flows, {
  contractState,
  log,
  zoeTools
});
```
### Public Facet and Invitation Creation [​](#public-facet-and-invitation-creation)

The contract provides a public-facing API (`publicFacet`) that allows external users to interact with it:

js
```
const publicFacet = zone.exo(
  'Send PF',
  M.interface('Send PF', {
    makeSendInvitation: M.callWhen().returns(InvitationShape)
  }),
  {
    makeSendInvitation() {
      return zcf.makeInvitation(
        orchFns.sendIt,
        'send',
        undefined,
        M.splitRecord({ give: SingleNatAmountRecord })
      );
    }
  }
);
```

The `makeSendInvitation` method creates an invitation for users, allowing them to initiate a transfer by submitting a proposal. The proposal must match the structure defined by the `SingleNatAmountRecord`, ensuring that only one asset is transferred per transaction. The invitation is connected to the `sendIt` function (explained later), which performs the asset transfer.

2. `send-anywhere.flows.js` [​](#_2-send-anywhere-flows-js)
-----------------------------------------------------------

This flows file defines a single function `sendIt` that handles offers made to the contract. The `sendIt` function is the core of the transfer process. It handles the actual movement of assets between the local and remote chains. The parameters passed to this function include:

* `orch`: The orchestrator object for managing chain/account interactions.
* `ctx`: The contract state and utility functions, including:
  + `contractState`: Holds the local account for intermediate storage.
  + `localTransfer`: The transfer function for moving assets between local accounts.
* `seat`: The Zoe seat representing the assets to be transferred.
* `offerArgs`: Includes details about the destination chain and address.

The `sendIt` function performs following important steps:

### Offer Validation and Setup [​](#offer-validation-and-setup)

Upon receiving an offer, the `sendIt` function:

* Validates the offer arguments using [endo's pattern-matching library](https://github.com/endojs/endo/tree/master/packages/patterns) to ensure the correct structure is submitted.
* Retrieves the `proposal` from the seat, extracting the asset (`brand` and `amount`) being transferred.
* The contract ensures that the asset brand is registered on the local chain by querying the chain’s asset registry (`vbank`). If not the contract throws an error and exits the transaction.
* If a local account for the contract doesn’t already exist, the function creates one.

js
```
mustMatch(offerArgs, harden({ chainName: M.scalar(), destAddr: M.string() }));
const { chainName, destAddr } = offerArgs;

const { give } = seat.getProposal();
const [[_kw, amt]] = entries(give);
void log(`sending {${amt.value}} from ${chainName} to ${destAddr}`);
const agoric = await orch.getChain('agoric');
const assets = await agoric.getVBankAssetInfo();
void log(`got info for denoms: ${assets.map(a => a.denom).join(', ')}`);
const { denom } = NonNullish(
  assets.find(a => a.brand === amt.brand),
  `${amt.brand} not registered in vbank`
);

if (!contractState.localAccount) {
  contractState.localAccount = await agoric.makeAccount();
}
```

This setup phase ensures the transaction is valid and the contract is prepared to handle it.

### Assets Transfer [​](#assets-transfer)

Once everything is validated, the contract performs the following steps:

* **Local transfer**: The assets are first transferred from the Zoe seat to the contract’s local account using `localTransfer` API.

js
```
await localTransfer(seat, contractState.localAccount, give);
```

* **Remote transfer**: The contract initiates the transfer to the destination address on the remote chain. This transfer includes details such as the destination chain ID and address.

js
```
await contractState.localAccount.transfer(
  {
    value: destAddr,
    encoding: 'bech32',
    chainId
  },
  { denom, value: amt.value }
);
```

* **Error handling**: If the transfer fails, the contract reverses the transaction by withdrawing the assets from the local account back to the Zoe seat. A detailed error message is logged and the seat is exited with the error. This process ensures that assets are transferred securely, with clear rollback mechanisms in case of failure.

js
```
await withdrawToSeat(contractState.localAccount, seat, give);
const errorMsg = `IBC Transfer failed ${q(e)}`;
void log(`ERROR: ${errorMsg}`);
seat.exit(errorMsg);
throw makeError(errorMsg);
```

Conclusion [​](#conclusion)
---------------------------

The "Send Anywhere" contract is a robust and flexible solution for transferring assets between blockchains. It ensures that:

* Assets are securely held in a local account before being transferred.
* Detailed logs are kept for transparency and error tracing.
* The contract is resilient to failure, with built-in rollback mechanisms.
* By using Agoric’s Orchestration tools, this contract provides a secure way to facilitate cross-chain asset transfers.
 [Help us improve this page!](https://github.com/Agoric/documentation/edit/main/main/guides/orchestration/contract-walkthroughs/send-anywhere.md)

Last Updated: 

Pager[Previous pageContract Walkthroughs](/guides/orchestration/contract-walkthroughs/)[Next pageCross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)

© 2024 Agoric Systems Operating Company. All Rights Reserved.



