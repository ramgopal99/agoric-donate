
 [Skip to content](#VPContent) [![](/agoric-logo-red.svg)Agoric Documentation](/)Search`K` Main Navigation Orchestrate[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)

Contract Walkthroughs

[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)

Example Orchestration DApp

[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)Build[Getting Started](/guides/getting-started/)[Smart Contract Basics](/guides/zoe/contract-basics.html)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[Permissioned Contract Deployment](/guides/coreeval/)[Integrating with Agoric Network](/guides/integration/chain-integration.html)[Agoric CLI](/guides/agoric-cli/)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[ERTP API](/reference/ertp-api/)[Zoe API](/reference/zoe-api/)[Example Zoe Contracts](/guides/zoe/contracts/)[End-to-End Testing](/e2e-testing.html)Learn[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[ERTP](/guides/ertp/)[JavaScript Framework](/guides/js-programming/)[Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)Tutorials[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[UI Tutorial](/guides/getting-started/ui-tutorial/)Support[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Github Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)

Appearance

MenuReturn to top Sidebar Navigation 

Orchestrate
-----------

[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)[### Contract Walkthroughs](/guides/orchestration/contract-walkthroughs/)[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)[### Example Orchestration DApp](/guides/orchestration/orchestration-basics/)[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)

Build
-----

[### Getting Started](/guides/getting-started/)[Takeaway 1: Starting a Local Chain](/guides/getting-started/explainer-how-to-start-a-local-chain.html)[Takeaway 2: Deploying a Smart Contract](/guides/getting-started/explainer-deploying-a-smart-contact.html)[Takeaway 3: Making an Offer](/guides/getting-started/explainer-how-to-make-an-offer.html)[### Smart Contract Basics](/guides/zoe/contract-basics.html)[Hello World Smart Contract](/guides/zoe/contract-hello.html)[State Smart Contract](/guides/zoe/contract-state.html)[Access Control Smart Contract](/guides/zoe/contract-access-control.html)[Complete Contract Walk-Through](/guides/zoe/contract-walkthru.html)[Durable Contract Details](/guides/zoe/contract-details.html)[Contract Upgrade](/guides/zoe/contract-upgrade.html)[Contract Governance](/guides/governance/)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[### Permissioned Contract Deployment](/guides/coreeval/)[Write Code to Deploy a Contract](/guides/coreeval/proposal.html)[Declare Required Capabilities](/guides/coreeval/permissions.html)[Submit Transactions](/guides/coreeval/local-testnet.html)[### Integrating with Agoric Network](/guides/integration/chain-integration.html)[Name Services: agoricNames, namesByAddress, board](/guides/integration/name-services.html)[SubQuery Indexing](/guides/subquery-indexing.html)[### Agoric CLI](/guides/agoric-cli/)[Agoric CLI Reference](/guides/agoric-cli/)[Using agd to make queries and transactions](/guides/agoric-cli/agd-query-tx.html)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[### ERTP API](/reference/ertp-api/)[ERTP API](/reference/ertp-api/)[Issuer Object](/reference/ertp-api/issuer.html)[Mint Object](/reference/ertp-api/mint.html)[Brand Object](/reference/ertp-api/brand.html)[Purse Object](/reference/ertp-api/purse.html)[Payment Object](/reference/ertp-api/payment.html)[AmountMath Object](/reference/ertp-api/amount-math.html)[ERTP Data Types](/reference/ertp-api/ertp-data-types.html)[### Zoe API](/reference/zoe-api/)[Zoe API](/reference/zoe-api/)[Zoe Service](/reference/zoe-api/zoe.html)[UserSeat Object](/reference/zoe-api/user-seat.html)[Zoe Contract Facet (ZCF)](/reference/zoe-api/zoe-contract-facet.html)[ZCFSeat Object](/reference/zoe-api/zcfseat.html)[ZCFMint Object](/reference/zoe-api/zcfmint.html)[ZoeHelper Functions](/reference/zoe-api/zoe-helpers.html)[Ratio Math Functions](/reference/zoe-api/ratio-math.html)[Zoe Data Types](/reference/zoe-api/zoe-data-types.html)[### Example Zoe Contracts](/guides/zoe/contracts/)[Example Zoe Contracts](/guides/zoe/contracts/)[Oracle Query Contract](/guides/zoe/contracts/oracle.html)[Vault Contract](/guides/zoe/contracts/vault.html)[Loan Contract](/guides/zoe/contracts/loan.html)[Funded Call Spread Contract](/guides/zoe/contracts/fundedCallSpread.html)[Priced Call Spread Contract](/guides/zoe/contracts/pricedCallSpread.html)[Covered Call Contract](/guides/zoe/contracts/covered-call.html)[OTC Desk Contract](/guides/zoe/contracts/otc-desk.html)[ConstantProduct AMM Contract](/guides/zoe/contracts/constantProductAMM.html)[Sell Items Contract](/guides/zoe/contracts/sell-items.html)[Atomic Swap Contract](/guides/zoe/contracts/atomic-swap.html)[Barter Exchange Contract](/guides/zoe/contracts/barter-exchange.html)[Second-Price Auction Contract](/guides/zoe/contracts/second-price-auction.html)[Simple Exchange Contract](/guides/zoe/contracts/simple-exchange.html)[Escrow To Vote Contract](/guides/zoe/contracts/escrow-to-vote.html)[Mint Payments Contract](/guides/zoe/contracts/mint-payments.html)[Mint and Sell NFTs Contract](/guides/zoe/contracts/mint-and-sell-nfts.html)[Use Object Contract](/guides/zoe/contracts/use-obj-example.html)[Automatic Refund Contract](/guides/zoe/contracts/automatic-refund.html)[End-to-End Testing](/e2e-testing.html)

Learn
-----

[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[### ERTP](/guides/ertp/)[Amounts, Values, and Brands](/guides/ertp/amounts.html)[AmountMath](/guides/ertp/amount-math.html)[Issuers and Mints](/guides/ertp/issuers-and-mints.html)[Purses and Payments](/guides/ertp/purses-and-payments.html)[JavaScript Framework](/guides/js-programming/)[### Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[PSM Contract](/guides/zoe/actual-contracts/PSM.html)[PriceAuthority Object](/reference/zoe-api/price-authority.html)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)

Tutorials
---------

[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[### dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[Takeaway 1: Sell Concert Tickets Contract Overview](/guides/getting-started/sell-concert-tickets-contract-explainer.html)[Takeaway 2: Swaparoo Contract Overview](/guides/getting-started/swaparoo-how-to-swap-assets-explainer.html)[Takeaway 3: Sending Invitation Payments using an Address](/guides/getting-started/swaparoo-making-a-payment-explainer.html)[### UI Tutorial](/guides/getting-started/ui-tutorial/)[1. Starting](/guides/getting-started/ui-tutorial/starting.html)[2. Agoric Provider](/guides/getting-started/ui-tutorial/agoric-provider.html)[3. Connect Wallet](/guides/getting-started/ui-tutorial/connect-wallet.html)[4. Querying Vstorage](/guides/getting-started/ui-tutorial/querying-vstorage.html)[5. Making an Offer](/guides/getting-started/ui-tutorial/making-an-offer.html)[6. Conclusion](/guides/getting-started/ui-tutorial/conclusion.html)

Support
-------

[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)On this page

ConstantProduct AMM Contract [​](#constantproduct-amm-contract)
===============================================================

 Zoe v0.24.0. Last updated August 25, 2022. 
##### [View the code on Github](https://github.com/Agoric/agoric-sdk/blob/7d141a47b311363f099f496d4ed9b4d0f28c8fff/packages/inter-protocol/src/vpool-xyk-amm/multipoolMarketMaker.js) (Last updated: Aug 15, 2022) [​](#view-the-code-on-github-last-updated-aug-15-2022)

##### [View contracts on Github](https://github.com/Agoric/agoric-sdk/tree/master/packages/zoe/src/contracts) [​](#view-contracts-on-github)

The Constant Product AMM is an automated market maker (AMM) that supports multiple liquidity pools and direct exchanges across pools. It's called the "Constant Product" AMM because it uses the constant product rule, which is one of a family of rules that enable a market maker to guarantee to be able to continue to make trades, regardless of how prices change. (The constant product rule does this by ensuring that the product of the contents of two pools of assets remains constant as trading takes place.)

Each liquidity pool maintains a price for exchanges between the central token and a secondary token. Secondary tokens can be exchanged with each other, but only through the central token. For example, if BLD and ATM are two token types and IST is the central currency, a swap giving ATM and wanting BLD would first use the pool (ATM, IST) then the pool (BLD, IST). There are no direct liquidity pools between two secondary tokens.

There should only need to be one instance of this contract, so liquidity can be shared as much as possible. Each secondary currency has a separate pool of liquidity.

When the contract is instantiated, the terms specify the central token. Invitations for adding and removing liquidity and for making trades are available by calling methods on the publicFacet. Other publicFacet operations support querying prices and the sizes of pools. Create new pools with `addPool()`.

When making trades or requesting prices, the caller must specify that either the input price (swapIn, getInputPrice) or the output price (swapOut, getOutputPrice) is fixed. For swaps, the required keywords are `In` for the trader's `give` amount, and `Out` for the trader's `want` amount. `getInputPrice()` and `getOutputPrice()` each take two amounts. When `getInputPrice()` or `swapIn()` is called, the `amountOut` parameter indicated the desired `amountOut`; if `amountIn` is insufficient to provide that much, the result indicates that no trade will take place. (The returned amountIn and amountOut will both be empty amounts.) Similarly, when `swapIn()` or `getOutputPrice()` is called, `amountIn` is treated as a maximum. If it would take a greater amount to get the specified `amountOut`, the result indicates no trade.

When adding and removing liquidity, the keywords are `Central`, `Secondary`, and `Liquidity`. Adding liquidity uses `Central` and `Secondary` in the `give` section and `Liquidity` in the `want` section. Removing liquidity reverses the keywords: `Liquidity` in the `give` section, and `Central` and `Secondary` in the want section. If the proposal specifies amounts directly taken from a recent quote, and any trading has intervened, the trade is unlikely to be accepted. You can either specify limits on how far the price may have moved, or specify limits of zero and trust the contract to trade fairly.

Transactions that don't require an invitation include `addPool()` and the queries (`getInputPrice()`, `getOutputPrice()`, `getPoolAllocation()`, `getLiquidityIssuer()`, and `getLiquiditySupply()`).

The ConstantProduct API [​](#the-constantproduct-api)
-----------------------------------------------------

These examples use IST as the central token. BLD and ATM are secondary currencies.

### Trading with the ConstantProduct AMM [​](#trading-with-the-constantproduct-amm)

Once trading pools have been set up (see below), a new trader can interact with the market by asking for the current price, making an invitation, and making an offer. If Sara has ATM and needs 275 BLD for a deal she has negotiated, she can use getOutputPrice() to get a quote. (An empty amount indicates no limit on the amountOut of the result.)

js
```
const quote = E(publicFacet).getOutputPrice(
  AmountMath.make(BLDBrand, 275n),
  AmountMath.makeEmpty(ATMBrand)
);
```

Let's assume the quote says she needs to provide 216 ATM. Sara believes the price is somewhat volatile, and she doesn't want to make repeated calls, so she pads her offer. If the appropriate pools don't exist, she'll get an error (`brands were not recognized`). If someone sells a lot of ATM into the pool just ahead of her, the price will increase, and she'll have to decide whether to deposit more ATM or wait for the price to stabilize. If someone buys a lot of ATM just ahead of her order, she'll get the 275 BLD for less and will get some ATM back.

js
```
const saraProposal = harden({
  want: { Out: AmountMath.make(BLDBrand, 275n) },
  give: { In: AmountMath.make(atmBrand, 220n) }
});

const swapInvitation = await E(publicFacet).makeSwapOutInvitation();
const atmPayment = harden({
  In: saraAtmPurse.withdraw(AmountMath.make(atmBrand, 220n))
});

const saraSeat = await E(zoe).offer(swapInvitation, saraProposal, atmPayment);
const saraResult = await saraSeat.getOfferResult();
```

If the result is `Swap successfully completed.`, she got the BLD for 220 ATM or less (she'll want to deposit any refund). Otherwise the market price moved against her, and she'll have to check the price again and make another offer.

js
```
const BLDProceeds = await E(saraSeat).getPayout('In');
const atmRefund = await E(saraSeat).getPayout('Out');

const BLDProceedsAmount = E(saraBLDPurse).deposit(BLDProceeds);
E(saraAtmPurse).deposit(atmRefund);
```
### Creating a New Pool [​](#creating-a-new-pool)

When the contract is first instantiated, there won't be any pools ready for trading. `addPool()` adds a new currency, which can then be funded. (All currencies must be fungible.) When a pool is first funded, there's no other basis on which to decide how much liquidity to create, so the liquidity amount equals the amount of the central token in the offer.

js
```
const BLDLiquidityIssuer = await E(publicFacet).addPool(BLDIssuer, 'BLD');
```

Alice sees that the current rate in the external market is 2 BLD for each IST, so she deposits twice as many BLD as IST to fund the market.

js
```
const aliceProposal = harden({
  want: { Liquidity: BLDLiquidity(50n) },
  give: {
    Secondary: AmountMath.make(BLDBrand, 100n),
    Central: AmountMath.make(ISTBrand, 50n)
  }
});
const alicePayments = {
  Secondary: aliceBLDPayment,
  Central: aliceISTPayment
};

const aliceAddLiquidityInvitation = E(publicFacet).makeAddLiquidityInvitation();
const addLiquiditySeat = await E(zoe).offer(
  aliceAddLiquidityInvitation,
  aliceProposal,
  alicePayments
);
```
### Adding Liquidity to an Existing Pool [​](#adding-liquidity-to-an-existing-pool)

When adding or removing liquidity to pools that have already been established, the amounts deposited must be in proportion to the current balances in the pool. The calculation is based on the amount of the `Central` asset. The `Secondary` assets must be added in proportion. If less `Secondary` is provided than required, the offer is exited with no trade. If more of the secondary is provided than is required, the excess is returned.

Bob calls `getPoolAllocation()` to find the relative levels. Let's say the answer is that the current ratio is 1234 BLD to 1718 IST.

js
```
const BLDPoolAlloc = E(publicFacet).getPoolAllocation(BLDBrand);
const ISTValue = BLDPoolAlloc.Central.value;
const BLDValue = BLDPoolAlloc.secondary.value;
```

Now he can add liquidity. The price ratio changes when anyone trades with the pool, so he should leave some flexibility in the proposal. The pool calculates the amount of `secondary` currency required based on the amount of `central` currency provided. Bob bumps up the amount of BLD he'll contribute by a little. If he was concerned about how much liquidity this would produce, he would calculate it and specify a rough figure, but there's no need in this case.

js
```
const bobProposal = harden({
  give: {
    Central: AmountMath.make(ISTBrand, 1800n),
    Secondary: AmountMath.make(BLDBrand, 1200n)
  },
  want: { Liquidity: AmountMath.make(liquidityBrand, 0n) },
  exit: { onDemand: null }
});

const bobPayments = {
  Central: bobISTPayment,
  Secondary: bobBLDPayment
};

const seat = await E(zoe).offer(addLiquidityInvite, bobProposal, bobPayments);
```

Governance [​](#governance)
---------------------------

The ConstantProduct AMM uses governance to manage changes to two parameters: `PoolFee` and `ProtocolFee`. The current values of the parameters and the history of governance voting to update their values is visible through the governance APIs.

An instance of the ConstantProduct AMM is managed by a contractGovernor, which controls the ability to change contract parameters and add new types of collateral. The contractGovernor adds these four methods to the contract's publicFacet:

* `getSubscription()`: get a [Subscription](/guides/js-programming/notifiers.html) that updates when votes are called.
* `getContractGovernor()`: returns the contractGovernor for verification.
* `getGovernedParamsValues()`: returns a structure showing the current values of the two parameters.
* `getParamValue('PoolFee')`: gets a description of the current value of either parameter. Note the initial capital letter.
 [Help us improve this page!](https://github.com/Agoric/documentation/edit/main/main/guides/zoe/contracts/constantProductAMM.md)

Last Updated: 

Pager[Previous pageOTC Desk Contract](/guides/zoe/contracts/otc-desk.html)[Next pageSell Items Contract](/guides/zoe/contracts/sell-items.html)

© 2024 Agoric Systems Operating Company. All Rights Reserved.



