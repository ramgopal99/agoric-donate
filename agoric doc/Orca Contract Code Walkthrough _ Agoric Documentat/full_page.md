
 [Skip to content](#VPContent) [![](/agoric-logo-red.svg)Agoric Documentation](/)Search`K` Main Navigation Orchestrate[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)

Contract Walkthroughs

[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)

Example Orchestration DApp

[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)Build[Getting Started](/guides/getting-started/)[Smart Contract Basics](/guides/zoe/contract-basics.html)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[Permissioned Contract Deployment](/guides/coreeval/)[Integrating with Agoric Network](/guides/integration/chain-integration.html)[Agoric CLI](/guides/agoric-cli/)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[ERTP API](/reference/ertp-api/)[Zoe API](/reference/zoe-api/)[Example Zoe Contracts](/guides/zoe/contracts/)[End-to-End Testing](/e2e-testing.html)Learn[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[ERTP](/guides/ertp/)[JavaScript Framework](/guides/js-programming/)[Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)Tutorials[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[UI Tutorial](/guides/getting-started/ui-tutorial/)Support[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Github Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)

Appearance

MenuReturn to top Sidebar Navigation 

Orchestrate
-----------

[What is Agoric Orchestration?](/guides/orchestration/)[Key Concepts and APIs](/guides/orchestration/key-concepts.html)[### Contract Walkthroughs](/guides/orchestration/contract-walkthroughs/)[Send Anywhere Example](/guides/orchestration/contract-walkthroughs/send-anywhere.html)[Cross-Chain Unbond Example](/guides/orchestration/contract-walkthroughs/cross-chain-unbond.html)[### Example Orchestration DApp](/guides/orchestration/orchestration-basics/)[Installation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Orca Contract walkthrough](/guides/orchestration/orchestration-basics/contract.html)[UI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)[How Orchestration Works](/guides/orchestration/how-orch-works.html)

Build
-----

[### Getting Started](/guides/getting-started/)[Takeaway 1: Starting a Local Chain](/guides/getting-started/explainer-how-to-start-a-local-chain.html)[Takeaway 2: Deploying a Smart Contract](/guides/getting-started/explainer-deploying-a-smart-contact.html)[Takeaway 3: Making an Offer](/guides/getting-started/explainer-how-to-make-an-offer.html)[### Smart Contract Basics](/guides/zoe/contract-basics.html)[Hello World Smart Contract](/guides/zoe/contract-hello.html)[State Smart Contract](/guides/zoe/contract-state.html)[Access Control Smart Contract](/guides/zoe/contract-access-control.html)[Complete Contract Walk-Through](/guides/zoe/contract-walkthru.html)[Durable Contract Details](/guides/zoe/contract-details.html)[Contract Upgrade](/guides/zoe/contract-upgrade.html)[Contract Governance](/guides/governance/)[UI Component Library](/guides/UIComponentLibrary/)[Building Client Dapps](/guides/getting-started/contract-rpc.html)[### Permissioned Contract Deployment](/guides/coreeval/)[Write Code to Deploy a Contract](/guides/coreeval/proposal.html)[Declare Required Capabilities](/guides/coreeval/permissions.html)[Submit Transactions](/guides/coreeval/local-testnet.html)[### Integrating with Agoric Network](/guides/integration/chain-integration.html)[Name Services: agoricNames, namesByAddress, board](/guides/integration/name-services.html)[SubQuery Indexing](/guides/subquery-indexing.html)[### Agoric CLI](/guides/agoric-cli/)[Agoric CLI Reference](/guides/agoric-cli/)[Using agd to make queries and transactions](/guides/agoric-cli/agd-query-tx.html)[Agoric API Reference](https://agoric-sdk.pages.dev/)[Endo API Reference](https://endojs.github.io/endo/)[### ERTP API](/reference/ertp-api/)[ERTP API](/reference/ertp-api/)[Issuer Object](/reference/ertp-api/issuer.html)[Mint Object](/reference/ertp-api/mint.html)[Brand Object](/reference/ertp-api/brand.html)[Purse Object](/reference/ertp-api/purse.html)[Payment Object](/reference/ertp-api/payment.html)[AmountMath Object](/reference/ertp-api/amount-math.html)[ERTP Data Types](/reference/ertp-api/ertp-data-types.html)[### Zoe API](/reference/zoe-api/)[Zoe API](/reference/zoe-api/)[Zoe Service](/reference/zoe-api/zoe.html)[UserSeat Object](/reference/zoe-api/user-seat.html)[Zoe Contract Facet (ZCF)](/reference/zoe-api/zoe-contract-facet.html)[ZCFSeat Object](/reference/zoe-api/zcfseat.html)[ZCFMint Object](/reference/zoe-api/zcfmint.html)[ZoeHelper Functions](/reference/zoe-api/zoe-helpers.html)[Ratio Math Functions](/reference/zoe-api/ratio-math.html)[Zoe Data Types](/reference/zoe-api/zoe-data-types.html)[### Example Zoe Contracts](/guides/zoe/contracts/)[Example Zoe Contracts](/guides/zoe/contracts/)[Oracle Query Contract](/guides/zoe/contracts/oracle.html)[Vault Contract](/guides/zoe/contracts/vault.html)[Loan Contract](/guides/zoe/contracts/loan.html)[Funded Call Spread Contract](/guides/zoe/contracts/fundedCallSpread.html)[Priced Call Spread Contract](/guides/zoe/contracts/pricedCallSpread.html)[Covered Call Contract](/guides/zoe/contracts/covered-call.html)[OTC Desk Contract](/guides/zoe/contracts/otc-desk.html)[ConstantProduct AMM Contract](/guides/zoe/contracts/constantProductAMM.html)[Sell Items Contract](/guides/zoe/contracts/sell-items.html)[Atomic Swap Contract](/guides/zoe/contracts/atomic-swap.html)[Barter Exchange Contract](/guides/zoe/contracts/barter-exchange.html)[Second-Price Auction Contract](/guides/zoe/contracts/second-price-auction.html)[Simple Exchange Contract](/guides/zoe/contracts/simple-exchange.html)[Escrow To Vote Contract](/guides/zoe/contracts/escrow-to-vote.html)[Mint Payments Contract](/guides/zoe/contracts/mint-payments.html)[Mint and Sell NFTs Contract](/guides/zoe/contracts/mint-and-sell-nfts.html)[Use Object Contract](/guides/zoe/contracts/use-obj-example.html)[Automatic Refund Contract](/guides/zoe/contracts/automatic-refund.html)[End-to-End Testing](/e2e-testing.html)

Learn
-----

[What is Agoric?](/what-is-agoric.html)[Agoric Platform](/guides/platform/)[Zoe Smart Contract Framework](/guides/zoe/)[### ERTP](/guides/ertp/)[Amounts, Values, and Brands](/guides/ertp/amounts.html)[AmountMath](/guides/ertp/amount-math.html)[Issuers and Mints](/guides/ertp/issuers-and-mints.html)[Purses and Payments](/guides/ertp/purses-and-payments.html)[JavaScript Framework](/guides/js-programming/)[### Deployed Zoe Contracts](/guides/zoe/actual-contracts/)[PSM Contract](/guides/zoe/actual-contracts/PSM.html)[PriceAuthority Object](/reference/zoe-api/price-authority.html)[Glossary](/glossary/)[Papers](https://agoric.com/papers/)

Tutorials
---------

[Tutorial: Dapp with Agoric](/guides/getting-started/tutorial/)[### dapp-agoric-basics](/guides/getting-started/tutorial-dapp-agoric-basics.html)[Takeaway 1: Sell Concert Tickets Contract Overview](/guides/getting-started/sell-concert-tickets-contract-explainer.html)[Takeaway 2: Swaparoo Contract Overview](/guides/getting-started/swaparoo-how-to-swap-assets-explainer.html)[Takeaway 3: Sending Invitation Payments using an Address](/guides/getting-started/swaparoo-making-a-payment-explainer.html)[### UI Tutorial](/guides/getting-started/ui-tutorial/)[1. Starting](/guides/getting-started/ui-tutorial/starting.html)[2. Agoric Provider](/guides/getting-started/ui-tutorial/agoric-provider.html)[3. Connect Wallet](/guides/getting-started/ui-tutorial/connect-wallet.html)[4. Querying Vstorage](/guides/getting-started/ui-tutorial/querying-vstorage.html)[5. Making an Offer](/guides/getting-started/ui-tutorial/making-an-offer.html)[6. Conclusion](/guides/getting-started/ui-tutorial/conclusion.html)

Support
-------

[Agoric](https://agoric.com/)[Discord](https://agoric.com/discord)[Discussions (Q&A)](https://github.com/Agoric/agoric-sdk/discussions)[Office Hours](https://github.com/Agoric/agoric-sdk/wiki/Office-Hours)[Twitter](https://twitter.com/agoric)[YouTube](https://www.youtube.com/channel/UCpY91oQLh_Lp0mitdZ5bYWg/)[Github](https://github.com/Agoric/)On this page

Orca Contract Code Walkthrough [​](#orca-contract-code-walkthrough)
===================================================================

This section provides a walkthrough of the Orca contract code, explaining its structure, key components, and functionality. The Orca contract is designed to manage Orchestration accounts and fund them. It interacts with multiple chains and provides functionality for creating accounts and funding them. The code for the contract logic is in two files:

1. [`orca.contract.js`](https://github.com/Agoric/dapp-orchestration-basics/blob/main/contract/src/orca.contract.js)
2. [`orca.flows.js`](https://github.com/Agoric/dapp-orchestration-basics/blob/main/contract/src/orca.flows.js)

`orca.contract.js` [​](#orca-contract-js)
-----------------------------------------

The `orca.contract.js` file brings in necessary dependencies and types from various Agoric packages. The `flows` import contains specific logic for the Orca contract offer handling operations.

js
```
import { AmountShape } from '@agoric/ertp';
import { makeTracer } from '@agoric/internal';
import { withOrchestration } from '@agoric/orchestration/src/utils/start-helper.js';
import { ChainInfoShape } from '@agoric/orchestration/src/typeGuards.js';
import { InvitationShape } from '@agoric/zoe/src/typeGuards.js';
import { M } from '@endo/patterns';
import * as flows from './orca.flows.js';
```
### Type Definitions and Shapes [​](#type-definitions-and-shapes)

The following definitions create shapes for validating the structure of `amount` and Orchestration powers.

js
```
const SingleAmountRecord = M.and(
  M.recordOf(M.string(), AmountShape, { numPropertiesLimit: 1 }),
  M.not(harden({}))
);

const OrchestrationPowersShape = M.splitRecord({
  localchain: M.remotable('localchain'),
  orchestrationService: M.remotable('orchestrationService'),
  storageNode: M.remotable('storageNode'),
  timerService: M.remotable('timerService'),
  agoricNames: M.remotable('agoricNames')
});
```
### Main Contract Function [​](#main-contract-function)

This is the main `contract` function that initializes and sets up the contract's functionality.

js
```
const contract = async (
  zcf,
  privateArgs,
  zone,
  { orchestrateAll, zoeTools, chainHub }
) => {
  // ... (contract logic)
};
```

Within the `contract` function, following actions are performed.

* **Chain Registration**: Below code section registers chains and their connections with the `chainHub`.

js
```
const { chainDetails } = zcf.getTerms();
for (const [name, info] of entries(chainDetails)) {
  const { connections = {} } = info;
  trace('register', name, {
    chainId: info.chainId,
    connections: keys(connections)
  });
  chainHub.registerChain(name, info);
  for (const [chainId, connInfo] of entries(connections)) {
    chainHub.registerConnection(info.chainId, chainId, connInfo);
  }
}
```

* **Creating Account and Funding Functions**: These functions are created using the `orchestrateAll` helper, which sets up the necessary flow logic for account creation and funding but the logic is implemented in `orca.flows.js` file ([discussed below](#orca-flows-js)).

js
```
const { makeAccount, makeCreateAndFund } = orchestrateAll(flows, {
  localTransfer: zoeTools.localTransfer
});
```

* **Public Facet**: The public facet provides two methods: `makeAccountInvitation` creates an invitation to make an Orchestration account, and `makeCreateAndFundInvitation` creates an invitation to make an account and fund it.

js
```
const publicFacet = zone.exo(
  'Orca Public Facet',
  M.interface('Orca PF', {
    makeAccountInvitation: M.callWhen().returns(InvitationShape),
    makeCreateAndFundInvitation: M.callWhen().returns(InvitationShape)
  }),
  {
    makeAccountInvitation() {
      return zcf.makeInvitation(makeAccount, 'Make an Orchestration Account');
    },
    makeCreateAndFundInvitation() {
      return zcf.makeInvitation(
        makeCreateAndFund,
        'Make an Orchestration Account and Fund it',
        undefined,
        M.splitRecord({ give: SingleAmountRecord })
      );
    }
  }
);
```
### `start` Function [​](#start-function)

The start function is wrapped with `withOrchestration`, which provides additional Orchestration setup and tools for the contract.

js
```
export const start = withOrchestration(contract);
harden(start);
```

`orca.flows.js` [​](#orca-flows-js)
-----------------------------------

This section provides a walkthrough of the `orca.flows.js` file, which contains flow functions for the Orca contract. The `orca.flows.js` file defines two main functions:

1. `makeAccount`: Creates an account on a Cosmos chain.
2. `makeCreateAndFund`: Creates an account on a Cosmos chain and funds it.

These functions are called by the Zoe vat when a user makes an offer using a corresponding orca contract inivitation.

### `makeAccount` Function [​](#makeaccount-function)

This function creates an account on a specified Cosmos chain. This function not only creates the account but also returns a continuing offer that allows the user to perform further actions like delegation, rewards withdrawl, and transfers. Here are the parameters of this function:

* `orch`: An Orchestrator instance parameter represents an instance of the `Orchestrator`, a powerful abstraction that manages interactions with the blockchain. It provides methods to interact with different chains, create accounts, and fetch chain information.
* `_ctx`: Unused context object
* `seat`: A `ZCFSeat` instance. It holds a proposal object corresponding to the current offer.
* `offerArgs`: An object containing `chainName` (that identifies the chain the Orchestration account should be created on) and `denom`.

The function validates the `offerArgs` to ensure it contains a `chainName`, retrieves the specified chain using `orch`, creates an account on the chain using `chain.makeAccount()`, and returns the account as a continuing offer. Below is the code of `makeAccount` after removing some debug information logging code.

js
```
mustMatch(offerArgs, M.splitRecord({ chainName: M.string() }));
const { chainName } = offerArgs;
seat.exit();
const chain = await orch.getChain(chainName);
const chainAccount = await chain.makeAccount();
return chainAccount.asContinuingOffer();
```

Once the account is created, the function returns a continuing offer by calling `chainAccount.asContinuingOffer()`. This allows the user to perform further actions on the account, such as delegating tokens or withdrawing rewards, through subsequent offers.

### `makeCreateAndFund` Function [​](#makecreateandfund-function)

This function creates an account on a specified Cosmos chain and funds it. It accepts the same set of parameters as `make Account`. The function:

* Extracts the amount to be transferred from the seat's proposal, and retrieves both the Agoric chain and the specified target chain.
* Fetches chain info and asset information.
* Creates accounts on both the Agoric chain (local) and the target chain (remote).
* Transfers funds from the seat to the local account.
* Transfers half of the received funds from the local account to the remote account.
* Checks the balance of the remote account, and returns the remote account as a continuing offer.

Below is the code of `makeCreateAndFund` after removing some debug information logging code.

js
```
const { give } = seat.getProposal();
const [[_kw, amt]] = Object.entries(give);
const [agoric, chain] = await Promise.all([
  orch.getChain('agoric'),
  orch.getChain(chainName)
]);
const localAccount = await agoric.makeAccount();
const remoteAccount = await chain.makeAccount();
const remoteAddress = await remoteAccount.getAddress();
await localTransfer(seat, localAccount, give);
await localAccount.transfer(
  {
    denom: 'ubld',
    value: amt.value / 2n
  },
  remoteAddress
);
seat.exit();
return remoteAccount.asContinuingOffer();
```

As in the previous case, the function returns a continuing offer by calling `remoteAccount.asContinuingOffer()` for further actions on the account.

Apart from above mentioned logic, several trace calls are made to log the current state of the function. This is useful for debugging and ensuring that the function's inputs and intermediate states are correct.

 [Help us improve this page!](https://github.com/Agoric/documentation/edit/main/main/guides/orchestration/orchestration-basics/contract.md)

Last Updated: 

Pager[Previous pageInstallation and Deployment](/guides/orchestration/orchestration-basics/installation.html)[Next pageUI Walkthrough](/guides/orchestration/orchestration-basics/ui.html)

© 2024 Agoric Systems Operating Company. All Rights Reserved.



